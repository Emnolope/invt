<!DOCTYPE html>
<html>
<head>
  <title>Table Integration Scaffold for Gemini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
/***** RESET *****/
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/***** LAYOUT *****/
body {
  height: 100vh;
  font-family: system-ui, -apple-system, sans-serif;
  overflow: hidden;
}

/***** UNIVERSAL BUTTON *****/
button {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2em;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  user-select: none;
  background: rgba(0, 0, 0, 0.5);
  color: white;
}
button:hover {
  background: rgba(0, 0, 0, 0.7);
}
button:active {
  background: rgba(0, 0, 0, 0.9);
}

/***** FIXED CONTROLS *****/
.fixed-controls {
  position: fixed;
  display: flex;
  gap: 10px;
  z-index: 1000;
}
.mode-controls {
  top: 20px;
  left: 20px;
  right: 20px;
  justify-content: space-between;
}

/***** MODE SYSTEM *****/
.mode {
  display: none;
}
.mode.active {
  display: block;
  position: fixed;
  inset: 0;
  overflow-y: auto;
  /* CRITICAL: Allow horizontal scrolling for the table mode */
  overflow-x: auto; 
  /* Add top padding to prevent fixed controls overlap */
  padding-top: 80px;
  /* Apply the monospace font to the table content only */
  font-family: 'Courier New', monospace;
}
.mode.active#mode-table {
  /* No vertical scrollbar on the mode itself, content handles it */
  overflow-y: hidden; 
}


/***** GEMINI SPREADSHEET STYLES *****/
#GridHeader, .Row {
  display: grid;
  /* Fixed column widths to enable scrolling: 40px (Thumb) + 4 Data columns */
  grid-template-columns: 40px 140px 140px 140px 166px; 
  width: 626px; /* Total fixed width for inner content */
  border-bottom: 1px solid #000;
  min-height: 16px;
  align-items: center;
  font-size: 14px;
}
#GridHeader {
  font-weight: bold;
  background: #ccc;
  position: sticky; /* Keep header visible during vertical scroll */
  top: 0;
  z-index: 10;
}
.Cell {
  overflow: hidden;
  white-space: nowrap;
  user-select: none;
  touch-action: manipulation;
}
.ThumbCell {
  text-align: center;
}
.Thumb {
  width: 100%;
  height: 14px;
  background: #666;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}
.Selected {
  background: #8cf;
} 
.Editing {
  background: #ff8;
}
input {
  width: 98%;
  box-sizing: border-box;
  font: inherit;
  padding: 0;
  border: 1px solid #000;
}
.table-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px 0;
    margin-top: 10px;
    width: 626px; /* Match grid width */
}
.table-controls button {
    font-size: 1em; /* smaller buttons for diagnostic use */
    padding: 5px 10px;
    border-radius: 4px;
}

/***** PLACEHOLDER CONTENT FOR OTHER MODES *****/
.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3em;
  color: #666;
}
  </style>
</head>
<body>
  <div id="mode-camera" class="mode placeholder">
    üì∏ Camera Mode
  </div>
  
  <div id="mode-gallery" class="mode placeholder">
    üñºÔ∏è Gallery Mode
  </div>
  
  <div id="mode-table" class="mode">
    <div style="min-width: 626px;">
        <div id="GridHeader"></div>
        <div id="GridBody"></div>
        <div class="table-controls">
            <button onclick="logSelected()">LOG SELECTED CELL IDs</button>
            <button onclick="clearSelection()">CLEAR SELECTION</button>
        </div>
    </div>
  </div>
  
  <div id="mode-settings" class="mode placeholder">
    ‚öôÔ∏è Settings Mode
  </div>

  <div class="fixed-controls mode-controls">
    <button onclick="uiBack()">‚¨ÖÔ∏è</button>
    <button onclick="uiNext()">‚û°Ô∏è</button>
  </div>

  <script>
/***** EXAMPLE DATA STRUCTURES (for reference only) *****/

// Example inventory structure:
let scaffoldInventory = {
  "20250604135552143": {
    ext: "jpg",
    values: "Bando.BoxA_c,t,b_GET__Fire gloves for workshop",
    thumbnail: null  // or dataURL string
  }
};

// Example schema structure:
let scaffoldSchema = [
  {
    name: "LocationPath",
    type: "text"
  },
  {
    name: "Category", 
    type: "multiple",
    options: ["c", "t", "b", "w", "f", "i", "e", "h", "v", "s"]
  },
  {
    name: "RetrievalFlag",
    type: "single", 
    options: ["GET", "STAY"]
  }
];

/***** FUNCTION INTERFACES (implement as needed) *****/

function valuesStringToArray(valuesString, schema = null) {
  // Parses: "Bando.BoxA_c,t,b_GET__Note"
  // Returns: [["Bando.BoxA"], ["c","t","b"], ["GET"], [], ["Note"]]
  console.log('‚ÜòÔ∏è valuesStringToArray:', valuesString);
  // Implementation needed
}

function valuesArrayToString(valuesArray) {
  // Reverse of above
  console.log('‚ÜòÔ∏è valuesArrayToString:', valuesArray);
  // Implementation needed
}

async function inventoryUpdate(newEntry) {
  // newEntry format: {uuid: {ext, values, thumbnail}}
  console.log('‚ÜòÔ∏è inventoryUpdate:', newEntry);
  // Implementation needed (triggers file rename in real system)
}

async function galleryThumbnailGet(uuid) {
  // Returns cached thumbnail or generates new one
  console.log('‚ÜòÔ∏è galleryThumbnailGet:', uuid);
  // Implementation needed
}

function navigateToGallery() {
  uiIndex = 1;
  uiRender();
}

/***** UI MODE SYSTEM (do not modify) *****/
const uiModes = {
  'mode-camera': 'üì∏',
  'mode-gallery': 'üñºÔ∏è',
  'mode-table': 'üìä',
  'mode-settings': '‚öôÔ∏è'
};
const uiArray = Object.keys(uiModes);
let uiIndex = 2; // Start on table mode

function uiNext() {
  uiIndex = (uiIndex + 1) % uiArray.length;
  uiRender();
}

function uiBack() {
  uiIndex = uiIndex ? uiIndex - 1 : uiArray.length - 1;
  uiRender();
}

function uiRender() {
  const name = uiArray[uiIndex];
  document.querySelectorAll('.mode').forEach(m => m.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  
  // CRITICAL: Call the table initialization function if the table mode is active
  if (name === 'mode-table' && !window.tableInitialized) {
      initTable();
      window.tableInitialized = true;
  }
}

/***** SPREADSHEET IMPLEMENTATION (Gemini Code) *****/

// --- DATA & STATE ---
const fieldNames = ['LocationPath', 'Category', 'Flag', 'Note']
const dataKeys = {uuid:'data-uuid', id:'data-cell-id'}
// Using a smaller, simplified inventory structure for this prototype
const inventory = {"20250604135552143":{thumbnail:"T1",LocationPath:"Bando.BoxA",Category:"c,t,b",Flag:"GET",Note:"Fire gloves"},"20250604135552144":{thumbnail:"T2",LocationPath:"Bando.BoxB",Category:"h,m",Flag:"INV",Note:"Power tool kit"},"20250604135552145":{thumbnail:"T3",LocationPath:"Shelf.L1",Category:"c",Flag:"PUT",Note:"Spare cables"},"20250604135552146":{thumbnail:"T4",LocationPath:"Rack.Bay2",Category:"t,b",Flag:"GET",Note:"Safety goggles"},"20250604135552147":{thumbnail:"T5",LocationPath:"Desk.Draw3",Category:"m",Flag:"INV",Note:"ID badge laminates"}}

let selectedCells = new Set()
let editingCellId = null
let pressTimer = null
let startX = 0, startY = 0
const longPressTime = 500, moveTolerance = 10
const D = document, H = D.getElementById('GridHeader'), B = D.getElementById('GridBody')

// --- LOGGING ---
const logNav = u=>console.log(`Maps:${u}`), logEdit = (i,v)=>console.log(`EDIT:${i}=${v}`)
const logSelect = ()=>console.log(`SELECT:${selectedCells.size} [${[...selectedCells].join(',')}]`)
const logSelected = ()=>console.log('Selected:',[...selectedCells])

// --- SELECTION UTILITIES ---
const clearSelection = ()=>{
  D.querySelectorAll('.Selected').forEach(c=>c.classList.remove('Selected'))
  selectedCells.clear(); logSelect()
}
const toggleSelection = (element, id)=>{
  selectedCells.has(id)?selectedCells.delete(id):selectedCells.add(id)
  element.classList.toggle('Selected'); logSelect()
}

// --- RENDERING ---
const createHeader = ()=>{
  H.innerHTML='';
  ['ACT',...fieldNames].map(text=>{const c=D.createElement('div');c.className='HeaderCell Cell';c.textContent=text;H.append(c)})
}
const renderInventory = ()=>{
  B.innerHTML='';
  Object.entries(inventory).map(([u,item])=>{
    const r=D.createElement('div');r.className='Row';r.setAttribute(dataKeys.uuid,u)

    // Leftmost Cell (Navigation)
    const tc=D.createElement('div');tc.className='Cell ThumbCell';tc.setAttribute(dataKeys.id,`${u}::t`)
    const td=D.createElement('div');td.className='Thumb';td.textContent=item.thumbnail
    tc.onclick=e=>{e.stopPropagation();editingCellId||logNav(u)};tc.append(td);r.append(tc)

    // Data Cells (Select/Edit)
    fieldNames.map(f=>{
      const c=D.createElement('div'),i=`${u}::${f}`
      c.className='Cell DataCell';c.setAttribute(dataKeys.id,i);c.textContent=item[f]
      selectedCells.has(i)&&c.classList.add('Selected')
      c.onclick=e=>handleTap(e,u,f,i)
      c.addEventListener('touchstart',handlePressStart)
      c.addEventListener('touchmove',handlePressMove)
      c.addEventListener('touchend',handlePressEnd)
      r.append(c)
    })
    B.append(r)
  })
}

// --- EDITING LOGIC ---
const saveEdit = (u,f,input,masterCell)=>{
  const v=input.value
  if(selectedCells.size>0){
    selectedCells.forEach(i=>{
      const [tU,tF]=i.split('::')
      inventory[tU][tF]=v,logEdit(i,v)
      const tE=D.querySelector(`[${dataKeys.id}="${i}"]`)
      tE&&(tE.textContent=v,tE.classList.remove('Selected'))
    })
  }else{
    inventory[u][f]=v,logEdit(`${u}::${f}`,v)
  }
  masterCell.innerHTML='',masterCell.textContent=v,masterCell.classList.remove('Editing')
  clearSelection(),editingCellId=null
}

const handleTap = (e,u,f,i)=>{
  e.stopPropagation() 

  if(editingCellId)D.querySelector(`[${dataKeys.id}="${editingCellId}"] input`).blur()
  
  const c=e.currentTarget
  !selectedCells.has(i)&&clearSelection()
  
  editingCellId=i;c.classList.add('Editing')
  const input=D.createElement('input')
  input.type='text';input.value=inventory[u][f]
  c.textContent='';c.append(input);input.focus()
  
  input.onblur=()=>saveEdit(u,f,input,c)
  
  input.onkeydown = ev => {
    ev.stopPropagation()
    if(ev.key === 'Enter') ev.currentTarget.blur()
  }
}

// --- TOUCH/LONG-PRESS LOGIC ---
const handlePressStart = e=>{
  if(editingCellId)return clearTimeout(pressTimer),pressTimer=null
  const c=e.currentTarget,i=c.getAttribute(dataKeys.id)
  startX=e.touches[0].clientX;startY=e.touches[0].clientY
  pressTimer=setTimeout(()=>{toggleSelection(c,i);pressTimer=null},longPressTime)
}
const handlePressMove = e=>{
  if(!pressTimer)return
  const dx=Math.abs(e.touches[0].clientX-startX),dy=Math.abs(e.touches[0].clientY-startY)
  if(dx>moveTolerance||dy>moveTolerance){clearTimeout(pressTimer);pressTimer=null}
}
const handlePressEnd = e=>pressTimer&&clearTimeout(pressTimer)

// --- TABLE INIT ---
function initTable() {
    createHeader(); 
    renderInventory();
    console.log('Spreadsheet Grid Initialized.');
}

/***** INIT *****/
uiRender();
console.log('üöÄ Scaffold loaded. Put your spreadsheet code in #mode-table');
  </script>
</body>
</html>
